{"title":"SSE流式输出原理及使用详解","uid":"38547b363f64ba7bc7ab5193d9c351bf","slug":"AI-SSE流式输出原理及使用详解","date":"2025-07-20T13:26:21.000Z","updated":"2025-11-23T09:38:15.606Z","comments":true,"path":"api/articles/AI-SSE流式输出原理及使用详解.json","keywords":"React、Vue、Uniapp、Nodejs、性能与优化","cover":"./../images/cover-ai.jpg","content":"<h5 id=\"一、什么是-SSE？\">一、什么是 SSE？</h5>\n<p>SSE（Server-Sent Events，服务器发送事件）是一种使用 <em>HTTP协议</em> 从 <em>服务器单向推送消息到浏览器</em> 的技术，它具有以下特点：</p>\n<ul>\n<li>单向：服务器 → 浏览器；</li>\n<li>基于 HTTP/1.1 长连接（持久连接）；</li>\n<li>使用 MIME 类型：text/event-stream；</li>\n<li>浏览器原生支持（EventSource）</li>\n</ul>\n<p>它适用于 ChatGPT 等流式输出、实时日志输出、实时进度条（上传/任务处理）、股票/新闻推送等场景，其 <em>消息格式</em> 及 <em>优缺点</em> 如下：</p>\n<table>\n<thead>\n<tr>\n<th>消息格式</th>\n<th>优点</th>\n<th>缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1. 每条消息以 data: 开头、<em>空行</em> 结束；</br> 2. <em>data</em>: 内容（可以多行）；</br> 3. <em>id</em>: 消息 ID，用于自动续传；</br> 4. <em>event</em>: 事件类型；</br> 5. <em>retry</em>: 客户端自动重连时间；</td>\n<td>1. 极度简单（无需协议升级）；</br> 2. 浏览器原生支持；</br> 3. 断线自动重连（自动带上 Last-Event-ID）；</br> 4. 文本流式传输天然友好；</td>\n<td>1. 不支持双向通信；</br> 2. 不适合发送二进制数据；</br> 3. 部分旧浏览器不支持（IE不支持）</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"二、前端接收：EventSource\">二、前端接收：EventSource</h5>\n<p>EventSource 是用于在客户端实现 SSE 协议的API，通过创建 EventSource 对象，网页可以与服务器建立 SSE 连接，接收实时更新的事件数据。但该方式<em>仅支持 Get 请求</em>。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// ------连接后端服务【GET方式: 定义EventSource对象】------</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> messages = <span class=\"title function_\">ref</span>([]); <span class=\"comment\">// 存储接收到的消息</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> message = <span class=\"string\">&#x27;&#x27;</span>; <span class=\"comment\">// 用户输入的消息</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 定义一个EventSource对象，传入请求地址 URL</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> eventSource = <span class=\"keyword\">new</span> <span class=\"title class_\">EventSource</span>(<span class=\"string\">`<span class=\"subst\">$&#123;baseUrl&#125;</span>?message=<span class=\"subst\">$&#123;<span class=\"built_in\">encodeURIComponent</span>(message)&#125;</span>`</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 与事件源的连接打开时触发</span></span><br><span class=\"line\">eventSource.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;open&quot;</span>, <span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(e, <span class=\"string\">&quot;SSE 连接已建立&quot;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 接收到事件源数据时触发</span></span><br><span class=\"line\">eventSource.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;message&quot;</span>, <span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (e.<span class=\"property\">data</span> === <span class=\"string\">&quot;[DONE]&quot;</span>) &#123;</span><br><span class=\"line\">    eventSource.<span class=\"title function_\">close</span>(); <span class=\"comment\">// 关闭 SSE 连接</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  messages.<span class=\"property\">value</span>[messages.<span class=\"property\">value</span>.<span class=\"property\">length</span> - <span class=\"number\">1</span>].<span class=\"property\">text</span> += e.<span class=\"property\">data</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;收到事件数据:&quot;</span>, eventData);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 与事件源的连接失败时触发</span></span><br><span class=\"line\">eventSource.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;error&quot;</span>, <span class=\"keyword\">function</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">   eventSource.<span class=\"title function_\">close</span>(); <span class=\"comment\">// 关闭 SSE 连接</span></span><br><span class=\"line\">   <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(e, <span class=\"string\">&quot;SSE 连接失败&quot;</span>);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<p>tips：使用浏览器提供的本地EventSource服务，无法获取连接状态编码。</p>\n<h5 id=\"三、前端接收：fetch-event-source\">三、前端接收：fetch-event-source</h5>\n<p>若想使用 POST 方式请求 eventSource，我们可以借助第三方库的 fetchEventSource 方法连接服务，通过 AbortController 对象可以关闭服务。</p>\n<p><strong>1、安装 fetch-event-source</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install --save @microsoft/fetch-event-source</span><br></pre></td></tr></table></figure>\n<p><strong>2、使用fetch-event-source</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> &#123; fetchEventSource &#125; <span class=\"keyword\">from</span> <span class=\"string\">&#x27;@microsoft/fetch-event-source&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ------变量定义------</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> userMessage = <span class=\"title function_\">ref</span>(<span class=\"string\">&#x27;&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> messages = <span class=\"title function_\">ref</span>([])</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">sendMessage</span> = <span class=\"keyword\">async</span> (<span class=\"params\"></span>) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">let</span> message = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 处理用户询问消息</span></span><br><span class=\"line\">  message = userMessage.<span class=\"property\">value</span>.<span class=\"title function_\">replace</span>(<span class=\"regexp\">/\\s+/g</span>, <span class=\"string\">&#x27;&#x27;</span>).<span class=\"title function_\">trim</span>()</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!message || isTyping.<span class=\"property\">value</span>) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 添加用户消息</span></span><br><span class=\"line\">  messages.<span class=\"property\">value</span>.<span class=\"title function_\">push</span>(&#123;</span><br><span class=\"line\">      <span class=\"attr\">text</span>: message,</span><br><span class=\"line\">      <span class=\"attr\">sender</span>: <span class=\"string\">&#x27;user&#x27;</span>,</span><br><span class=\"line\">      <span class=\"attr\">timestamp</span>: <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>().<span class=\"title function_\">toISOString</span>()</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">  userMessage.<span class=\"property\">value</span> = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"comment\">// 发送消息给后端</span></span><br><span class=\"line\"> <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">  messages.<span class=\"property\">value</span>.<span class=\"title function_\">push</span>(&#123;</span><br><span class=\"line\">      <span class=\"attr\">text</span>: <span class=\"string\">&#x27;&#x27;</span>,</span><br><span class=\"line\">      <span class=\"attr\">sender</span>: <span class=\"string\">&#x27;bot&#x27;</span>,</span><br><span class=\"line\">      <span class=\"attr\">timestamp</span>: <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>().<span class=\"title function_\">toISOString</span>()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 连接后端服务【POST方式: 使用fetchEventSource】</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> ctrlAbort = <span class=\"keyword\">new</span> <span class=\"title class_\">AbortController</span>();</span><br><span class=\"line\">    <span class=\"keyword\">const</span> &#123; signal &#125; = ctrlAbort;</span><br><span class=\"line\">    <span class=\"title function_\">fetchEventSource</span>(<span class=\"string\">&#x27;你的后端API地址&#x27;</span>, &#123;</span><br><span class=\"line\">      <span class=\"attr\">method</span>: <span class=\"string\">&#x27;POST&#x27;</span>,</span><br><span class=\"line\">      <span class=\"attr\">headers</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;Content-Type&quot;</span>: <span class=\"string\">&#x27;application/json;charset=UTF-8&#x27;</span>,</span><br><span class=\"line\">          <span class=\"string\">&quot;Accept&quot;</span>: <span class=\"string\">&#x27;text/event-stream&#x27;</span>       </span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"attr\">body</span>: <span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(&#123; hasFirst, message &#125;),</span><br><span class=\"line\">      <span class=\"attr\">signal</span>: signal, <span class=\"comment\">// AbortSignal</span></span><br><span class=\"line\">      <span class=\"attr\">openWhenHidden</span>: <span class=\"literal\">true</span>, <span class=\"comment\">// 取消visibilityChange事件</span></span><br><span class=\"line\">      <span class=\"title function_\">onmessage</span>(<span class=\"params\">event</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 操作流式数据</span></span><br><span class=\"line\">        messages.<span class=\"property\">value</span>[messages.<span class=\"property\">value</span>.<span class=\"property\">length</span> - <span class=\"number\">1</span>].<span class=\"property\">text</span> += event.<span class=\"property\">data</span></span><br><span class=\"line\">        <span class=\"title function_\">scrollToBottomSmooth</span>()</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"title function_\">onclose</span>(<span class=\"params\"></span>) &#123;  </span><br><span class=\"line\">        ctrlAbort.<span class=\"title function_\">abort</span>() <span class=\"comment\">// 中断流式返回</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"title function_\">onerror</span>(<span class=\"params\">error</span>) &#123;          </span><br><span class=\"line\">        ctrlAbort.<span class=\"title function_\">abort</span>() <span class=\"comment\">// 中断流式返回</span></span><br><span class=\"line\">        <span class=\"keyword\">throw</span> error <span class=\"comment\">// 直接抛出错误，避免反复调用</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (error) &#123;</span><br><span class=\"line\">  messages.<span class=\"property\">value</span>.<span class=\"title function_\">push</span>(&#123;</span><br><span class=\"line\">      <span class=\"attr\">text</span>: <span class=\"string\">&#x27;请求失败，请稍后再试&#x27;</span>,</span><br><span class=\"line\">      <span class=\"attr\">sender</span>: <span class=\"string\">&#x27;bot&#x27;</span>,</span><br><span class=\"line\">      <span class=\"attr\">timestamp</span>: <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>().<span class=\"title function_\">toISOString</span>()</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>AbortController 是浏览器提供的可中断异步操作的标准机制，可用于中断 fetch、耗时的异步任务等。创建 AbortController 对象后，对象中包含一个 signal（只读对象，用于向异步操作发出 “是否需要中断” 的通知），当你调用对象中的 abort() 方法时，signal会立刻：</p>\n<ul>\n<li>1、aborted = true；</li>\n<li>2、reason = new DOMException(“AbortError”, …)；</li>\n<li>3、abort 事件触发（所有监听器执行）；</li>\n<li>4、所有基于此 signal 的异步任务立即中断（如 fetch）且不能恢复；</li>\n</ul>\n<h5 id=\"四、前端接收：fetch\">四、前端接收：fetch</h5>\n<p>fetch 可以请求 event-source，支持 post，get 请求，但没有 onmessage 方法来处理流数据，需要从请求中读取响应流数据，并处理数据格式。</p>\n<figure class=\"highlight ts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"title class_\">Message</span> = &#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> messages = ref&lt;<span class=\"title class_\">Message</span>[]&gt;([])</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">send</span> = <span class=\"keyword\">async</span> (<span class=\"params\"></span>) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> <span class=\"attr\">userMsg</span>: <span class=\"title class_\">Message</span> = &#123; <span class=\"attr\">id</span>: <span class=\"title class_\">Date</span>.<span class=\"title function_\">now</span>(), <span class=\"attr\">role</span>: <span class=\"string\">&#x27;user&#x27;</span>, <span class=\"attr\">text</span>: input.<span class=\"property\">value</span> &#125;</span><br><span class=\"line\">  messages.<span class=\"property\">value</span>.<span class=\"title function_\">push</span>(userMsg)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> res = <span class=\"keyword\">await</span> <span class=\"title function_\">fetch</span>(<span class=\"string\">&#x27;你的后端API地址&#x27;</span>, &#123;</span><br><span class=\"line\">    <span class=\"attr\">method</span>: <span class=\"string\">&#x27;POST&#x27;</span>,</span><br><span class=\"line\">    <span class=\"attr\">headers</span>: &#123; <span class=\"string\">&#x27;Content-Type&#x27;</span>: <span class=\"string\">&#x27;application/json&#x27;</span> &#125;,</span><br><span class=\"line\">    <span class=\"attr\">body</span>: <span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(&#123; <span class=\"attr\">query</span>: input.<span class=\"property\">value</span> &#125;),</span><br><span class=\"line\">    ...其他参数</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!res.<span class=\"property\">body</span>) <span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> reader = res.<span class=\"property\">body</span>.<span class=\"title function_\">getReader</span>() <span class=\"comment\">// 获取响应体的数据读取器</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> decoder = <span class=\"keyword\">new</span> <span class=\"title class_\">TextDecoder</span>(<span class=\"string\">&#x27;utf-8&#x27;</span>) <span class=\"comment\">// 创建用于解码文本的解码器</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> buffer = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 临时的 assistant 消息</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> assistantMsg = reactive&lt;<span class=\"title class_\">Message</span>&gt;(&#123; <span class=\"attr\">id</span>: <span class=\"title class_\">Date</span>.<span class=\"title function_\">now</span>() + <span class=\"number\">1</span>, <span class=\"attr\">role</span>: <span class=\"string\">&#x27;assistant&#x27;</span>, <span class=\"attr\">text</span>: <span class=\"string\">&#x27;&#x27;</span> &#125;)</span><br><span class=\"line\">  messages.<span class=\"property\">value</span>.<span class=\"title function_\">push</span>(assistantMsg)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> &#123; done, value &#125; = <span class=\"keyword\">await</span> reader.<span class=\"title function_\">read</span>() <span class=\"comment\">// 读取数据块</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (done) <span class=\"keyword\">break</span> <span class=\"comment\">// 流结束</span></span><br><span class=\"line\">    buffer += decoder.<span class=\"title function_\">decode</span>(value, &#123; <span class=\"attr\">stream</span>: <span class=\"literal\">true</span> &#125;)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> chunks = buffer.<span class=\"title function_\">split</span>(<span class=\"string\">&quot;\\n\\n&quot;</span>) <span class=\"comment\">// 按 SSE 格式分割消息</span></span><br><span class=\"line\">    buffer = chunks.<span class=\"title function_\">pop</span>() || <span class=\"string\">&#x27;&#x27;</span> <span class=\"comment\">// 保留不完整的消息到下一次循环中</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> chunk <span class=\"keyword\">of</span> chunks) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!chunk.<span class=\"title function_\">startsWith</span>(<span class=\"string\">&#x27;data: &#x27;</span>)) <span class=\"keyword\">continue</span></span><br><span class=\"line\">      <span class=\"keyword\">const</span> payloadStr = chunk.<span class=\"title function_\">slice</span>(<span class=\"number\">5</span>).<span class=\"title function_\">trim</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!payloadStr) <span class=\"keyword\">continue</span></span><br><span class=\"line\">      <span class=\"keyword\">const</span> payload = <span class=\"title class_\">JSON</span>.<span class=\"title function_\">parse</span>(payloadStr) <span class=\"comment\">// 解析JSON</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 根据后端定义的 type 执行不同操作</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (payload.<span class=\"property\">type</span> === <span class=\"string\">&#x27;text&#x27;</span>) &#123;</span><br><span class=\"line\">        assistantMsg.<span class=\"property\">text</span> = (assistantMsg.<span class=\"property\">text</span> || <span class=\"string\">&#x27;&#x27;</span>) + <span class=\"title class_\">String</span>(payload.<span class=\"property\">delta</span> || <span class=\"string\">&#x27;&#x27;</span>)</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (payload.<span class=\"property\">type</span> === <span class=\"string\">&#x27;chart&#x27;</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 收到图表消息，创建一个新的 assistant 消息来展示图表</span></span><br><span class=\"line\">        assistantMsg.<span class=\"property\">sql</span> = payload.<span class=\"property\">sql</span></span><br><span class=\"line\">        assistantMsg.<span class=\"property\">option</span> = payload.<span class=\"property\">option</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","text":"一、什么是 SSE？ SSE（Server-Sent Events，服务器发送事件）是一种使用 HTTP协议 从 服务器单向推送消息到浏览器 的技术，它具有以下...","permalink":"/post/AI-SSE流式输出原理及使用详解","photos":[],"count_time":{"symbolsCount":"5.9k","symbolsTime":"5 mins."},"categories":[{"name":"AI","slug":"AI","count":2,"path":"api/categories/AI.json"}],"tags":[{"name":"SSE","slug":"SSE","count":2,"path":"api/tags/SSE.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E4%B8%80%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF-SSE%EF%BC%9F\"><span class=\"toc-text\">一、什么是 SSE？</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E4%BA%8C%E3%80%81%E5%89%8D%E7%AB%AF%E6%8E%A5%E6%94%B6%EF%BC%9AEventSource\"><span class=\"toc-text\">二、前端接收：EventSource</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E4%B8%89%E3%80%81%E5%89%8D%E7%AB%AF%E6%8E%A5%E6%94%B6%EF%BC%9Afetch-event-source\"><span class=\"toc-text\">三、前端接收：fetch-event-source</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E5%9B%9B%E3%80%81%E5%89%8D%E7%AB%AF%E6%8E%A5%E6%94%B6%EF%BC%9Afetch\"><span class=\"toc-text\">四、前端接收：fetch</span></a></li></ol>","author":{"name":"YaZhen","slug":"blog-author","avatar":"/images/avatar.png","link":"/","description":"喜欢深耕知识的技术人","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"CSS基础知识总结","uid":"04bb7135e476c44e9016e2d68b372071","slug":"CSS-基础知识总结","date":"2025-08-09T04:26:21.000Z","updated":"2025-11-26T02:41:25.493Z","comments":true,"path":"api/articles/CSS-基础知识总结.json","keywords":"React、Vue、Uniapp、Nodejs、性能与优化","cover":"./../images/cover.png","text":"一、CSS 简介与引入方式 CSS 的全称是 层叠样式表（Cascading Style Sheets），它也是一种标记语言，用于控制网页的样式与布局，比如颜色...","permalink":"/post/CSS-基础知识总结","photos":[],"count_time":{"symbolsCount":"31k","symbolsTime":"28 mins."},"categories":[{"name":"CSS","slug":"CSS","count":3,"path":"api/categories/CSS.json"}],"tags":[{"name":"技术总结","slug":"技术总结","count":4,"path":"api/tags/技术总结.json"}],"author":{"name":"YaZhen","slug":"blog-author","avatar":"/images/avatar.png","link":"/","description":"喜欢深耕知识的技术人","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"使用hexo搭建个人博客","uid":"28b56a6d628adf0e2a41ab59435138a8","slug":"hexo-blog","date":"2025-07-15T12:24:53.000Z","updated":"2025-11-24T01:25:03.789Z","comments":true,"path":"api/articles/hexo-blog.json","keywords":"React、Vue、Uniapp、Nodejs、性能与优化","cover":"./../images/cover.png","text":"Hexo 是一个快速、简洁且高效的静态博客框架，支持丰富的主题和插件，非常适合前端进行个人博客的搭建，以下是小编使用 Hexo 搭建个人博客的步骤记录： 一、安...","permalink":"/post/hexo-blog","photos":[],"count_time":{"symbolsCount":"1.8k","symbolsTime":"2 mins."},"categories":[{"name":"hexo","slug":"hexo","count":1,"path":"api/categories/hexo.json"}],"tags":[{"name":"博客搭建","slug":"博客搭建","count":1,"path":"api/tags/博客搭建.json"}],"author":{"name":"YaZhen","slug":"blog-author","avatar":"/images/avatar.png","link":"/","description":"喜欢深耕知识的技术人","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}