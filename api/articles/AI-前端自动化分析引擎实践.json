{"title":"AI前端自动化分析引擎实践","uid":"f317a7d1b7b450391801a105fa63c4b1","slug":"AI-前端自动化分析引擎实践","date":"2025-07-25T13:26:21.000Z","updated":"2025-11-23T04:32:39.520Z","comments":true,"path":"api/articles/AI-前端自动化分析引擎实践.json","keywords":"React、Vue、Uniapp、Nodejs、性能与优化","cover":"./../images/cover-ai.jpg","content":"<p>近期跟后端同事配合开发了一个AI智能对话系统，对 AI、LLM 等知识产生了浓厚的兴趣，故构建了一个基于大语言模型（LLM）的智能数据可视化引擎。用户可以通过自然语言输入查询，系统能够智能地将其转换为数据图表，实现数据分析的“对话式”交互。该博客为项目实践笔记，记录了项目的实现思路、技术选型和所遇问题的解决方案。</p>\n<h5 id=\"一、实现思路\">一、实现思路</h5>\n<img src=\"/post/AI-%E5%89%8D%E7%AB%AF%E8%87%AA%E5%8A%A8%E5%8C%96%E5%88%86%E6%9E%90%E5%BC%95%E6%93%8E%E5%AE%9E%E8%B7%B5/AI-%E5%89%8D%E7%AB%AF%E8%87%AA%E5%8A%A8%E5%8C%96%E5%88%86%E6%9E%90%E5%BC%95%E6%93%8E%E5%AE%9E%E8%B7%B5-01.png\" class=\"\">\n<p><strong>1、用户输入</strong></p>\n<p>用户在前端界面输入自然语言查询，例如：“请生成一个产品分类的折线图”。</p>\n<p><strong>2、API请求</strong></p>\n<p>前端将用户的查询作为请求体（body），向后端的 API 发送 post 请求。</p>\n<p><strong>3、API服务处理</strong></p>\n<ul>\n<li>Nuxt 后端服务器接收到请求后，通过 Server-Sent Events（SSE）与前端建立一个持久连接，以便流式传输响应。</li>\n<li>初始化一个 ChatOllama 实例，连接到本地运行的 qwen3:8b 模型。</li>\n<li>连接数据库，获取 users和orders表的CREATE TABLE语句。</li>\n<li>构建 Prompt1。</li>\n<li>调用 callOllama(prompt1)。</li>\n<li>LLM返回SQL字符串：SELECT… 。</li>\n<li>执行SQL：连接数据库，执行该SQL。</li>\n<li>构建 Prompt2，它包含原始问题、SQL结果和 查询出的原始数据。</li>\n<li>调用 callOllama(prompt2)。</li>\n<li>LLM返回一个完整的ECharts option JSON对象。</li>\n<li>后端通过SSE将这个option对象发送给前端。</li>\n</ul>\n<p><strong>4、前端状态更新</strong></p>\n<p>前端通过监听 SSE 的 message 事件来接收数据，并将新的图表配置添加到一个全局的charts数据中。</p>\n<p><strong>5、图表渲染</strong></p>\n<p>前端通过 Vue 的 watch 监听 charts数据，当数据发生变化时，将新的图表配置传递给 ECharts 进行渲染，最终将数据可视化地呈现给用户。</p>\n<h5 id=\"二、技术选型\">二、技术选型</h5>\n<p><strong>1、核心框架</strong></p>\n<ul>\n<li>Nuxt 4: 作为项目的基础，Nuxt 是一个基于 Vue.js 的全栈框架，提供了服务端渲染（SSR）、文件系统路由、自动导入等功能，极大地简化了复杂应用的开发。其主要优势在于：\n<ul>\n<li>同构应用：一套代码可以同时运行在服务器和客户端，有利于SEO和首屏加载速度。</li>\n<li>约定大于配置：预设的目录结构和命名约定减少了繁琐的配置工作。</li>\n<li>模块生态强大：模块化设计使得第三方模块的集成非常容易（eg: Pinia、Tailwind CSS）。</li>\n</ul>\n</li>\n</ul>\n<p><strong>2、状态管理</strong></p>\n<ul>\n<li>Pinia: Vue3 的状态管理库，轻量、简洁且对TypeScript友好支持。</li>\n</ul>\n<p><strong>3、UI 组件</strong></p>\n<ul>\n<li>shadcn-nuxt &amp; Tailwind CSS: 提供了一系列高质量、可定制的UI组件，与原子化CSS框架完美结合，实现了高效、灵活的UI开发。</li>\n</ul>\n<p><strong>4、数据可视化</strong></p>\n<ul>\n<li>Echarts: 适用于多种数据的可视化解决方案，如折线图、饼图、柱状图等。</li>\n</ul>\n<p><strong>5、AI &amp; 大语言模型（LLM）</strong></p>\n<ul>\n<li>Ollama: 一个用于本地部署和运行大型语言模型（eg: qwen3:8b）的工具，支持模型量化、微调及RAG应用‌。</li>\n</ul>\n<h5 id=\"三、项目搭建\">三、项目搭建</h5>\n<p><strong>1、创建项目</strong></p>\n<p>根据 <a href=\"https://nuxt.com/docs/4.x/getting-started/installation\">Nuxt 官方文档</a>，使用 pnpm 创建项目（本人 node 版本为 20.19.5 ）。</p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pnpm create nuxt@latest &lt;project-name&gt;  // 创建项目</span><br><span class=\"line\"><span class=\"built_in\">cd</span> &lt;project-name&gt; // 进入项目目录</span><br><span class=\"line\">pnpm install // 安装依赖</span><br><span class=\"line\">pnpm dev // 启动项目</span><br></pre></td></tr></table></figure>\n<p>本人创建项目时遇到的问题：</p>\n<p><em>问题1</em>：执行 pnpm create nuxt@latest nuxt-app 时报错：Error: Failed to download template from registry: Failed to download <a href=\"https://raw.githubusercontent.com/nuxt/starter/templates/templates/v4.json\">https://raw.githubusercontent.com/nuxt/starter/templates/templates/v4.json</a>: TypeError: fetch failed.</p>\n<p><em>问题定位</em>：浏览器访问 ‘<a href=\"https://raw.githubusercontent.com/nuxt/starter/templates/templates/v4.json\">https://raw.githubusercontent.com/nuxt/starter/templates/templates/v4.json</a>’ 可以正常展示，故使用 nslookup <a href=\"http://raw.githubusercontent.com\">raw.githubusercontent.com</a> 命令查看 <a href=\"http://raw.githubusercontent.com\">raw.githubusercontent.com</a> 的 IP 地址，发现是 0.0.0.0（DNS 解析失败）。</p>\n<p><em>问题原因</em>：node 内置fetch 拉取时遇到路由器的 DNS 解析问题。</p>\n<p><em>解决方案</em>：</p>\n<ul>\n<li>方案1、修改系统 DNS（macOS 进入： 系统设置 → 网络 → Wi-Fi → 详情 → DNS）</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">添加：</span><br><span class=\"line\">  8.8.8.8</span><br><span class=\"line\">  1.1.1.1</span><br><span class=\"line\">  223.5.5.5  <span class=\"comment\"># 阿里</span></span><br><span class=\"line\">  114.114.114.114</span><br><span class=\"line\"></span><br><span class=\"line\">然后重启网络：</span><br><span class=\"line\">  <span class=\"built_in\">sudo</span> dscacheutil -flushcache</span><br><span class=\"line\">  <span class=\"built_in\">sudo</span> killall -HUP mDNSResponder</span><br></pre></td></tr></table></figure>\n<ul>\n<li>方案2、全局 hosts 指定 GitHub Raw 的 IP（强硬方式）</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> nano /etc/hosts // 进入 hosts 配置文件</span><br><span class=\"line\">185.199.108.133 raw.githubusercontent.com // 添加这行代码</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> dscacheutil -flushcache // 保存后重启网络</span><br></pre></td></tr></table></figure>\n<p><em>问题2</em>：执行 pnpm create nuxt@latest nuxt-app 时继续报错：ERROR  Cannot find native binding. npm has a bug related to optional dependencies (<a href=\"https://github.com/npm/cli/issues/4828\">https://github.com/npm/cli/issues/4828</a>). Please try npm i again after removing both package-lock.json and node_modules directory.</p>\n<p><em>问题原因</em>：node 版本不一致，默认使用的是 v18.20.7 (Node.js 18)，但 stable 指向 v20.17.0 (Node.js 20)，导致产生了原生模块编译问题。</p>\n<p><em>解决方案</em>：</p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 设置 v20.19.5 为默认版本</span></span><br><span class=\"line\">nvm <span class=\"built_in\">alias</span> default v20.19.5</span><br><span class=\"line\">nvm use default</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 清理项目依赖并重新安装</span></span><br><span class=\"line\"><span class=\"built_in\">rm</span> -rf node_modules package-lock.json</span><br><span class=\"line\">npm cache clean --force</span><br><span class=\"line\">npm install</span><br></pre></td></tr></table></figure>\n<p><strong>2、集成UI框架：Tailwind CSS &amp; shadcn/ui</strong></p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npx shadcn-nuxt init // 初始化shadcn-nuxt</span><br></pre></td></tr></table></figure>\n<ul>\n<li>该命令会引导你完成一系列配置，主要包括：\n<ul>\n<li><em>配置 tailwind.config.ts</em>: 自动生成 Tailwind CSS 的配置文件。</li>\n<li><em>创建 assets/css/tailwind.css</em>: 引入 Tailwind 的基础组件和工具样式。</li>\n<li><em>更新 nuxt.config.ts</em>: 自动注册 shadcn-nuxt 模块，并配置组件的存放目录。</li>\n<li><em>创建components.json</em>: 用于记录你项目中已添加的 shadcn 组件和相关配置。</li>\n</ul>\n</li>\n</ul>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pnpm add tailwindcss @tailwindcss/vite -D // 添加 tailwindcss</span><br><span class=\"line\"></span><br><span class=\"line\">// 然后在 nuxt.config.ts 文件中加入以下配置</span><br><span class=\"line\">import tailwindcss from <span class=\"string\">&#x27;@tailwindcss/vite&#x27;</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> default defineNuxtConfig(&#123;</span><br><span class=\"line\">  // ...</span><br><span class=\"line\">  css: [<span class=\"string\">&#x27;~/assets/css/tailwind.css&#x27;</span>],</span><br><span class=\"line\">  vite: &#123;</span><br><span class=\"line\">    plugins: [</span><br><span class=\"line\">      tailwindcss(),</span><br><span class=\"line\">    ],</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pnpm dlx shadcn-vue@latest add button // 添加组件</span><br></pre></td></tr></table></figure>\n<p>执行后，Button.vue 的源代码就会被自动创建在 components/ui/button 目录下，开发者可以随时按照需求进行修改。</p>\n<p><strong>3、项目模块结构</strong></p>\n<p>Nuxt 通过基于<em>文件的路由</em>和<em>布局系统</em>来组织界面。</p>\n<ul>\n<li>\n<p>app/app.vue：这是应用的根组件，是所有页面的主入口，它通常包含 <NuxtLayout> 和 <NuxtPage> 这两个核心组件，前者定义全局布局，后者则负责渲染当前路由匹配到的页面。</p>\n</li>\n<li>\n<p>app/pages/ 目录：Nuxt会自动根据这个目录下的文件结构生成Vue Router的路由配置。例如，app/pages/dashboard/index.vue 文件会自动映射到 /dashboard 这个路由。</p>\n</li>\n<li>\n<p>app/components/ 目录：这是存放自定义Vue组件的地方。Nuxt会自动导入此目录下的所有组件，你可以在任何页面或布局中直接使用，无需手动import。</p>\n</li>\n<li>\n<p>server/api/ 目录：创建的任何文件都会被自动映射为一个API端点。命名规则遵循 [文件名].[HTTP请求方式].ts 的格式（defineEventHandler 是 Nuxt 提供的用于定义请求处理器的函数）。</p>\n</li>\n</ul>\n<p><strong>4、大模型选择与本地部署</strong></p>\n<p>我们将使用 Ollama 框架，并以阿里通义千问的 qwen 系列模型。</p>\n<p>Ollama是一个开源的、轻量级的本地LLM运行框架。你可以把它理解为“本地LLM的Docker”：</p>\n<ul>\n<li>一键安装：提供了macOS，Windows，Linux的图形化安装包。</li>\n<li>一键运行：使用ollama run &lt;model_name&gt;即可下载并运行模型。</li>\n<li>内置AP：启动后，Ollama会自动在本地Loca1host：11434端口开启一个兼容 OpenAI 格式的 API服务。</li>\n</ul>\n<p>安装Ollama：访问 <a href=\"https://ollama.com/\">ollama 官方网站</a>，根据你的操作系统下载对应的安装包并进行安装。不幸的是博主的电脑系统版本较低，出现了该问题：“应用程序“Ollama”的这个版本不能与此版本的macOS配合使用。你使用的是macOS 13.0。该应用程序要求macOS 14.0或更高版本”。故下载的是0.11.2（<a href=\"https://github.com/ollama/ollama/releases?page=3\">Ollama-0.11.2 下载地址</a>）</p>\n<p>执行命令：ollama run qwen3:8b 拉取并自动加载模型，进入一个交互式聊天界面，接下来我们进行一下模型测试。</p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 命令行交互测试</span><br><span class=\"line\">&gt;&gt;&gt;你好，请中文介绍自己。</span><br><span class=\"line\">你好！我是一个大型语言模型，由阿里云通义千问团队训练而成。</span><br><span class=\"line\">我被设计用来理解和生成人类语言，可以回答问题、撰写文章、翻译文本等等...</span><br><span class=\"line\"></span><br><span class=\"line\">// API接口测试（再重新打开一个新的终端运行）【model-指定调用模型；prompt-发送的提示词；stream-是否流式返回】</span><br><span class=\"line\">curl http://localhost:11434/api/generate -d <span class=\"string\">&#x27;&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;model&quot;: &quot;qwen3:8b&quot;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;prompt&quot;: &quot;为什么天空是蓝色的?&quot;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;stream&quot;: false</span></span><br><span class=\"line\"><span class=\"string\">&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// 执行后会收到一个 JSON 格式的响应</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;model&quot;</span>: <span class=\"string\">&quot;qwen3:8b&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;created_at&quot;</span>: <span class=\"string\">&quot;2025-11-04T02:45:00.123Z&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;response&quot;</span>: <span class=\"string\">&quot;天空呈现蓝色是因为瑞利散射现象.当太阳光穿过地球大气层时,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;</span><span class=\"keyword\">done</span><span class=\"string\">&quot;: true,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;</span>context<span class=\"string\">&quot;: [...]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p><strong>5、数据库环境搭建</strong></p>\n<p>因为我们要让大语言模型(LLM)直接与真实数据库交互，根据用户的自然语言查询动态生成SQL，执行查询，并最终将结果呈现出来（即Text-to-SQL），就需要 Docker 和 PostgreSQL 数据库，</p>\n<p>由于博主的 MacOS 系统版本较低，不支持最新版的 Docker，所以下载的是 4.5.0 版本（<a href=\"https://docs.docker.com/desktop/release-notes/#macos\">docker 历史下载地址</a>）</p>\n<p>PostgreSQL是一个强大且流行的开源关系型数据库，非常适合作为我们的数据源。我们可以使用Docker轻松地在本地启动一个PostgreSQL服务。运行命令：</p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 1.后台启动一个名为 my-postgres 的 PostgreSQL 容器；2.设置数据库的超级用户admin的密码为admin123；3.默认数据库mydb；4.将容器的5432端口映射到你本机的5432端口；</span><br><span class=\"line\">docker run -d \\</span><br><span class=\"line\">  --name my-postgres \\</span><br><span class=\"line\">  -e POSTGRES_USER=admin \\</span><br><span class=\"line\">  -e POSTGRES_PASSWORD=admin123 \\</span><br><span class=\"line\">  -p 5432:5432 \\</span><br><span class=\"line\">  postgres</span><br><span class=\"line\"></span><br><span class=\"line\">// docker 其他常见命令</span><br><span class=\"line\">docker pull nginx // 拉取 nginx 镜像</span><br><span class=\"line\">docker rmi nginx // 删除 nginx 镜像</span><br><span class=\"line\">docker images // 查看所有镜像</span><br><span class=\"line\">docker ps // 查看运行中的容器</span><br><span class=\"line\">docker run nginx // 创建并运行 nginx 镜像</span><br><span class=\"line\">docker run -d  nginx  // 在后台运行一个 nginx 镜像</span><br><span class=\"line\">docker run -p 80:80 nginx  // 运行 nginx 镜像，并把主机的 80 端口映射到容器的 80 端口</span><br><span class=\"line\">docker run stop nginx // 停止 nginx 容器</span><br><span class=\"line\">docker <span class=\"built_in\">rm</span> nginx // 删除容器(可加上 -f 参数强制删除, eg: docker <span class=\"built_in\">rm</span> -f my-postgres)</span><br><span class=\"line\">docker volume <span class=\"built_in\">rm</span> pgdata // 删除容器数据卷</span><br><span class=\"line\">docker stats // 实时资源统计</span><br><span class=\"line\">docker logs // 查看容器日志</span><br><span class=\"line\">docker <span class=\"built_in\">exec</span> -it &lt;container&gt; bash // 进入容器</span><br><span class=\"line\">docker ps -a | grep my-postgres // 查看旧容器状态  </span><br></pre></td></tr></table></figure>\n<p><em>tips: 拉去镜像时，我们大多数会遇到失败的情况，因为镜像仓库被墙了。此时我们可以添加如下代码使用国内景象。点击：docker.desktop -&gt; settings -&gt; Docker engine 后添加如下代码：“registry-mirrors”: [“<a href=\"https://docker.m.daocloud.io\">https://docker.m.daocloud.io</a>”, “<a href=\"https://docker.1panel.live\">https://docker.1panel.live</a>”, “<a href=\"https://hub.rat.dev\">https://hub.rat.dev</a>”]</em></p>\n<p>数据库启动后，我们需要创建一些基础数据，命令如下：</p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 连接 PostgreSQL 数据（也可使用[DBeaver]工具操作或测试连接）</span><br><span class=\"line\">docker <span class=\"built_in\">exec</span> -it my-postgres psql -U admin -d postgres</span><br><span class=\"line\"></span><br><span class=\"line\">// 进入后你会看到如下代码，代表成功进入 PostgreSQL（\\q: 退出）。</span><br><span class=\"line\">postgres=#</span><br><span class=\"line\"></span><br><span class=\"line\">-- 创建用户表</span><br><span class=\"line\">CREATE TABLE <span class=\"built_in\">users</span> (</span><br><span class=\"line\">  user_id INT PRIMARY KEY, </span><br><span class=\"line\">  user_name VARCHAR(50), </span><br><span class=\"line\">  registration_date DATE</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">--创建订单表</span><br><span class=\"line\">CREATE TABLE orders(</span><br><span class=\"line\">  order_id INT PRIMARY KEY, </span><br><span class=\"line\">  user_id INT,</span><br><span class=\"line\">  product_name VARCHAR(100),</span><br><span class=\"line\">  amount DECIMAL(10,2), </span><br><span class=\"line\">  order_date DATE,</span><br><span class=\"line\">  FOREIGN KEY (user_id) REFERENCES <span class=\"built_in\">users</span>(user_id)</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">--插入测试数据</span><br><span class=\"line\">INSERT INTO <span class=\"built_in\">users</span> (user_id, user_name, registration_date ) VALUES </span><br><span class=\"line\">(1, <span class=\"string\">&#x27;张三&#x27;</span>, <span class=\"string\">&#x27;2023-01-15&#x27;</span>), </span><br><span class=\"line\">(2, <span class=\"string\">&#x27;李四&#x27;</span>, <span class=\"string\">&#x27;2023-02-20&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">INSERT INTO orders (order_id, user_id, product_name, amount, order_date) VALUES (101, 1, <span class=\"string\">&#x27;笔记本电脑&#x27;</span>, 5000.00, <span class=\"string\">&#x27;2024-03-10&#x27;</span>), </span><br><span class=\"line\">(102, 2, <span class=\"string\">&#x27;智能手机&#x27;</span>, 3200.00, <span class=\"string\">&#x27;2024-03-12&#x27;</span>), </span><br><span class=\"line\">(103, 1, <span class=\"string\">&#x27;机械键盘&#x27;</span>, 800.00, <span class=\"string\">&#x27;2024-04-05&#x27;</span>), </span><br><span class=\"line\">(104, 1, <span class=\"string\">&#x27;显示器&#x27;</span>, 1500.00, <span class=\"string\">&#x27;2024-05-21);</span></span><br></pre></td></tr></table></figure>\n<p>然后构造一个特殊的提示词(Prompt)，这个提示词包含了数据库的模式(Schema)信息。因为LLM本身对你的数据库结构（有哪些表、表里有哪些 字段、字段间有什么关系)一无所知。你必须在提问时，把这些“上下文信息”告诉它。让 LLM “认识”数据库的过程被称为&quot;基于模式的提示词工程&quot;(Schema-based Prompt Engineering)。</p>\n<p>一个典型的Text-to-SQL提示词结构如下（Prompt1）：</p>\n  <figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">你是一个PostgreSQL数据库专家。根据下面的数据库表结构和用户的问题，生成一个准确的<span class=\"keyword\">SQL</span>查询语句。 </span><br><span class=\"line\"></span><br><span class=\"line\">##数据库表结构：</span><br><span class=\"line\">&#123;schema&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">###用户问题：</span><br><span class=\"line\">&#123;question&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">##<span class=\"keyword\">SQL</span> 查询：</span><br></pre></td></tr></table></figure>\n<p>这里的{schema}部分，就是你需要动态填充的数据库表结构。你可以通过程序连接数据库，查询其元数据(metadata)，然后将 CREATE TABLE语句或者一个简化的描述填充进去。示例Prompt：</p>\n  <figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">你是一个PostgreSQL数据库专家。根据下面的数据库表结构和用户的问题，生成一个准确的<span class=\"keyword\">SQL</span>查询语句。 </span><br><span class=\"line\"></span><br><span class=\"line\">###数据库表结构：</span><br><span class=\"line\"><span class=\"keyword\">CREATE TABLE</span> users (</span><br><span class=\"line\">  user_id <span class=\"type\">INT</span> <span class=\"keyword\">PRIMARY KEY</span>, <span class=\"comment\">--用户ID</span></span><br><span class=\"line\">  user_name <span class=\"type\">VARCHAR</span>(<span class=\"number\">50</span>), <span class=\"comment\">--用户名</span></span><br><span class=\"line\">  registration_dateDATE <span class=\"comment\">--注册日期</span></span><br><span class=\"line\">)；</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">CREATE TABLE</span> orders (</span><br><span class=\"line\">  order_id <span class=\"type\">INT</span> <span class=\"keyword\">PRIMARY KEY</span>, <span class=\"operator\">-</span> 订单ID <span class=\"number\">79927</span></span><br><span class=\"line\">  user_id <span class=\"type\">INT</span>, <span class=\"operator\">-</span>用户ID(外键)</span><br><span class=\"line\">  product_name <span class=\"type\">VARCHAR</span>(I00), <span class=\"operator\">-</span>产品名称</span><br><span class=\"line\">  amount <span class=\"type\">DECIMAL</span>(<span class=\"number\">10</span>, <span class=\"number\">2</span>), <span class=\"comment\">--订单金额</span></span><br><span class=\"line\">  order_date <span class=\"type\">DATE</span>, <span class=\"comment\">--订单日期</span></span><br><span class=\"line\">  <span class=\"keyword\">FOREIGN KEY</span> (user_id) <span class=\"keyword\">REFERENCES</span> users(user_id)</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">###用户问题：</span><br><span class=\"line\">统计每个用户的总订单金额</span><br><span class=\"line\"></span><br><span class=\"line\">###<span class=\"keyword\">SQL</span>查询：</span><br></pre></td></tr></table></figure>\n<p>当你把这样一个信息完备的Prompt发送给LLM时,它就拥有了生成正确SQL所需的全部上下文,从而能够返回:</p>\n  <figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> u.user_name, <span class=\"built_in\">SUM</span>(o.amount) <span class=\"keyword\">As</span> total_amount</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> users u</span><br><span class=\"line\"><span class=\"keyword\">JOIN</span> orders o <span class=\"keyword\">ON</span> u.user_id <span class=\"operator\">=</span> o.user_id </span><br><span class=\"line\"><span class=\"keyword\">GROUP</span> <span class=\"keyword\">BY</span> u.user_name;</span><br></pre></td></tr></table></figure>\n<p>构建Prompt2，它包含原始问题、SQL查询、以及查询出的原始数据。Prompt2示例：</p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">你是一个数据可视化专家。根据用户的原始问题和查询到的数据，生成一个ECharts的option JS0N 对象来可视化这些数据，使用折线图。</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">###原始问题:</span></span><br><span class=\"line\">  统计每个用户的总订单金额</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">##查询到的数据(JS0N格式):</span></span><br><span class=\"line\">  [</span><br><span class=\"line\">    &#123;“user_name“：“张三“，“total，_amount“：“5800。00“&#125;，</span><br><span class=\"line\">    &#123;“user_name“：“李四“，“total。_amount“：“3200。00“&#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">##ECharts Option:</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"四、重点代码：SSE-实现流式响应\">四、重点代码：SSE 实现流式响应</h5>\n<p>服务端关键代码：</p>\n  <figure class=\"highlight ts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// app/utils/db.ts</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">const</span> db = <span class=\"keyword\">new</span> <span class=\"title class_\">Pool</span>(&#123;</span><br><span class=\"line\">  <span class=\"attr\">host</span>: xxx, <span class=\"comment\">// 数据库主机</span></span><br><span class=\"line\">  <span class=\"attr\">port</span>: xxx, <span class=\"comment\">// 数据库端口</span></span><br><span class=\"line\">  <span class=\"attr\">database</span>: xxx, <span class=\"comment\">// 数据库名称</span></span><br><span class=\"line\">  <span class=\"attr\">user</span>: xxx, <span class=\"comment\">// 数据库用户名</span></span><br><span class=\"line\">  <span class=\"attr\">password</span>: xxx, <span class=\"comment\">// 数据库密码</span></span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 便捷查询封装，返回行数组</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">runQuery</span>(<span class=\"params\"><span class=\"attr\">sql</span>: <span class=\"built_in\">string</span>, <span class=\"attr\">params</span>?: <span class=\"built_in\">any</span>[]</span>): <span class=\"title class_\">Promise</span>&lt;<span class=\"built_in\">any</span>[]&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> res = <span class=\"keyword\">await</span> db.<span class=\"title function_\">query</span>(sql, params)</span><br><span class=\"line\">  <span class=\"keyword\">return</span> res.<span class=\"property\">rows</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n  <figure class=\"highlight ts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// app/utils/ollama.ts</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; $fetch &#125; <span class=\"keyword\">from</span> <span class=\"string\">&#x27;ofetch&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Ollama 服务地址与默认模型可通过环境变量配置，提高灵活性</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">OLLAMA_URL</span> = xxx <span class=\"comment\">// ollama 服务地址</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">DEFAULT_MODEL</span> = xxx <span class=\"comment\">// 默认模型</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 通用超时封装，便于在服务端任意异步操作设置上限</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">async</span> <span class=\"keyword\">function</span> withTimeout&lt;T&gt;(<span class=\"attr\">promise</span>: <span class=\"title class_\">Promise</span>&lt;T&gt;, <span class=\"attr\">ms</span>: <span class=\"built_in\">number</span>): <span class=\"title class_\">Promise</span>&lt;T | <span class=\"literal\">null</span>&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> <span class=\"title class_\">Promise</span>.<span class=\"title function_\">race</span>([</span><br><span class=\"line\">    promise,</span><br><span class=\"line\">    <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>&lt;T | <span class=\"literal\">null</span>&gt;(<span class=\"function\">(<span class=\"params\">resolve</span>) =&gt;</span> <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> <span class=\"title function_\">resolve</span>(<span class=\"literal\">null</span>), ms))</span><br><span class=\"line\">  ])</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 轻量打字机效果，用于 SSE 文本增量输出</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">typewriter</span>(<span class=\"params\"><span class=\"attr\">send</span>: (p: <span class=\"built_in\">any</span>) =&gt; <span class=\"built_in\">void</span>, <span class=\"attr\">text</span>: <span class=\"built_in\">string</span>, chunkSize = <span class=\"number\">6</span>, delay = <span class=\"number\">60</span></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> s = <span class=\"title class_\">String</span>(text)</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i = <span class=\"number\">0</span>; i &lt; s.<span class=\"property\">length</span>; i += chunkSize) &#123;</span><br><span class=\"line\">    <span class=\"title function_\">send</span>(&#123; <span class=\"attr\">type</span>: <span class=\"string\">&#x27;text&#x27;</span>, <span class=\"attr\">delta</span>: s.<span class=\"title function_\">slice</span>(i, i + chunkSize) &#125;)</span><br><span class=\"line\">    <span class=\"keyword\">await</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">r</span>) =&gt;</span> <span class=\"built_in\">setTimeout</span>(r, delay))</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 统一的 Ollama 生成接口，支持可选参数和超时</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">interface</span> <span class=\"title class_\">OllamaOptions</span> &#123;</span><br><span class=\"line\">  <span class=\"attr\">model</span>?: <span class=\"built_in\">string</span></span><br><span class=\"line\">  <span class=\"attr\">stream</span>?: <span class=\"built_in\">boolean</span></span><br><span class=\"line\">  <span class=\"attr\">timeoutMs</span>?: <span class=\"built_in\">number</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">callOllama</span>(<span class=\"params\"><span class=\"attr\">prompt</span>: <span class=\"built_in\">string</span>, <span class=\"attr\">opts</span>: <span class=\"title class_\">OllamaOptions</span> = &#123;&#125;</span>): <span class=\"title class_\">Promise</span>&lt;<span class=\"built_in\">string</span>&gt; &#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> model = opts.<span class=\"property\">model</span> || <span class=\"variable constant_\">DEFAULT_MODEL</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> stream = opts.<span class=\"property\">stream</span> ?? <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> timeoutMs = opts.<span class=\"property\">timeoutMs</span> ?? <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> <span class=\"title function_\">exec</span> = <span class=\"keyword\">async</span> (<span class=\"params\"></span>) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">const</span> res = <span class=\"keyword\">await</span> $fetch(<span class=\"string\">`<span class=\"subst\">$&#123;OLLAMA_URL&#125;</span>/api/generate`</span>, &#123;</span><br><span class=\"line\">        <span class=\"attr\">method</span>: <span class=\"string\">&#x27;POST&#x27;</span>,</span><br><span class=\"line\">        <span class=\"attr\">headers</span>: &#123; <span class=\"string\">&#x27;Content-Type&#x27;</span>: <span class=\"string\">&#x27;application/json&#x27;</span> &#125;,</span><br><span class=\"line\">        <span class=\"attr\">body</span>: &#123; model, stream, prompt &#125;,</span><br><span class=\"line\">      &#125;) <span class=\"keyword\">as</span> <span class=\"built_in\">any</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">typeof</span> res === <span class=\"string\">&#x27;string&#x27;</span> ? res : (res?.<span class=\"property\">response</span> || <span class=\"string\">&#x27;&#x27;</span>)</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (err) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">error</span>(<span class=\"string\">&#x27;[LLM] 调用失败：&#x27;</span>, err)</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (timeoutMs &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> out = <span class=\"keyword\">await</span> <span class=\"title function_\">withTimeout</span>(<span class=\"title function_\">exec</span>(), timeoutMs)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> out || <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> <span class=\"title function_\">exec</span>()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n  <figure class=\"highlight ts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">getSchema</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">    CREATE TABLE users (</span></span><br><span class=\"line\"><span class=\"string\">      user_id INT PRIMARY KEY, -- 用户ID</span></span><br><span class=\"line\"><span class=\"string\">      user_name VARCHAR(50),   -- 用户名</span></span><br><span class=\"line\"><span class=\"string\">      registration_date DATE   -- 注册日期</span></span><br><span class=\"line\"><span class=\"string\">    );</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    CREATE TABLE orders (</span></span><br><span class=\"line\"><span class=\"string\">      order_id INT PRIMARY KEY,     -- 订单ID</span></span><br><span class=\"line\"><span class=\"string\">      user_id INT,                  -- 用户ID(外键)</span></span><br><span class=\"line\"><span class=\"string\">      product_name VARCHAR(100),    -- 产品名称</span></span><br><span class=\"line\"><span class=\"string\">      amount DECIMAL(10,2),         -- 订单金额</span></span><br><span class=\"line\"><span class=\"string\">      order_date DATE,              -- 订单日期</span></span><br><span class=\"line\"><span class=\"string\">      FOREIGN KEY (user_id) REFERENCES users(user_id)</span></span><br><span class=\"line\"><span class=\"string\">    );</span></span><br><span class=\"line\"><span class=\"string\">  `</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n  <figure class=\"highlight ts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// server/api/generatev2.post.ts</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; runQuery &#125; <span class=\"keyword\">from</span> <span class=\"string\">&#x27;~/utils/db&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; callOllama, withTimeout, typewriter &#125; <span class=\"keyword\">from</span> <span class=\"string\">&#x27;~/utils/ollama&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; getSchema &#125; <span class=\"keyword\">from</span> <span class=\"string\">&#x27;~/utils/schema&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> <span class=\"title function_\">defineEventHandler</span>(<span class=\"title function_\">async</span> (event) =&gt; &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 1. 设置响应头</span></span><br><span class=\"line\">  <span class=\"title function_\">setResponseHeaders</span>(event, &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;Content-Type&quot;</span>: <span class=\"string\">&#x27;text/event-stream&#x27;</span>, <span class=\"comment\">// 声明为SSE 流</span></span><br><span class=\"line\">    <span class=\"string\">&quot;Cache-Control&quot;</span>: <span class=\"string\">&quot;no-cache&quot;</span>, <span class=\"comment\">// 禁用缓存</span></span><br><span class=\"line\">    <span class=\"string\">&quot;Connection&quot;</span>: <span class=\"string\">&quot;keep-alive&quot;</span>, <span class=\"comment\">// 保持连接</span></span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">const</span> body = <span class=\"keyword\">await</span> <span class=\"title function_\">readBody</span>(event)</span><br><span class=\"line\">  <span class=\"keyword\">const</span> query = <span class=\"title class_\">String</span>(body?.<span class=\"property\">query</span> || <span class=\"string\">&quot;&quot;</span>).<span class=\"title function_\">trim</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 2.定义一个发送函数</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> <span class=\"title function_\">send</span> = (<span class=\"params\"><span class=\"attr\">payload</span>: <span class=\"built_in\">any</span></span>) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 必须遵循 “data: ...\\n\\n” 格式</span></span><br><span class=\"line\">    event.<span class=\"property\">node</span>.<span class=\"property\">res</span>.<span class=\"title function_\">write</span>(<span class=\"string\">`data: <span class=\"subst\">$&#123;<span class=\"built_in\">JSON</span>.stringify(payload)&#125;</span>\\n\\n`</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 3. 发送开始信号</span></span><br><span class=\"line\">  <span class=\"title function_\">send</span>(&#123; <span class=\"attr\">type</span>: <span class=\"string\">&quot;start&quot;</span>, query &#125;); </span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 结合大模型与数据库：生成 SQL -&gt; 查询数据 -&gt; 返回图表（不做打字机效果）</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> analysis = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> <span class=\"attr\">chartHint</span>: &#123; <span class=\"attr\">sql</span>?: <span class=\"built_in\">string</span>, <span class=\"attr\">chartType</span>?: <span class=\"built_in\">string</span> &#125; = &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> schema = <span class=\"keyword\">await</span> <span class=\"title function_\">getSchema</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 先打字机分析文本（简短，不阻塞）</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> analysisPrompt = <span class=\"string\">`请用中文简要分析用户问题的查询思路，不要输出SQL。用1-2句，控制在120字以内。\\n用户问题：<span class=\"subst\">$&#123;query&#125;</span>`</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> analysisText = <span class=\"keyword\">await</span> <span class=\"title function_\">withTimeout</span>(<span class=\"title function_\">callOllama</span>(analysisPrompt), <span class=\"number\">30000</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (analysisText) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">await</span> <span class=\"title function_\">typewriter</span>(send, <span class=\"title class_\">String</span>(analysisText))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 定义 SQL 生成提示词</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> prompt = <span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">      你是一个PostgreSQL数据库专家。根据下面的数据库表结构和用户的问题，生成一个准确的SQL查询语句。</span></span><br><span class=\"line\"><span class=\"string\">      ## 数据库表结构:</span></span><br><span class=\"line\"><span class=\"string\">      <span class=\"subst\">$&#123;schema&#125;</span></span></span><br><span class=\"line\"><span class=\"string\">      ### 用户问题：</span></span><br><span class=\"line\"><span class=\"string\">      <span class=\"subst\">$&#123;query&#125;</span></span></span><br><span class=\"line\"><span class=\"string\">      ### SQL查询语句:</span></span><br><span class=\"line\"><span class=\"string\">      输出要求：</span></span><br><span class=\"line\"><span class=\"string\">      - 只返回一个完整的只读查询（SELECT 或 WITH），不要任何解释。</span></span><br><span class=\"line\"><span class=\"string\">      - 将SQL放在\\`\\`\\`sql\\`\\`\\`代码块中，并以分号结尾。</span></span><br><span class=\"line\"><span class=\"string\">      - 禁止使用 UPDATE/DELETE/INSERT/ALTER/DROP/TRUNCATE 等修改语句。`</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> responseText = <span class=\"keyword\">await</span> <span class=\"title function_\">withTimeout</span>(<span class=\"title function_\">callOllama</span>(prompt), <span class=\"number\">30000</span>) || <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!responseText) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">console</span>.<span class=\"title function_\">warn</span>(<span class=\"string\">&#x27;[Prompt1 timeout or empty]&#x27;</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> sql = <span class=\"title function_\">extractSqlFromText</span>(responseText)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (sql) &#123;</span><br><span class=\"line\">      chartHint.<span class=\"property\">sql</span> = sql</span><br><span class=\"line\">      <span class=\"comment\">// 简单启发式：包含 GROUP BY 则默认柱状图</span></span><br><span class=\"line\">      chartHint.<span class=\"property\">chartType</span> = <span class=\"regexp\">/group\\s+by/i</span>.<span class=\"title function_\">test</span>(sql) ? <span class=\"string\">&#x27;bar&#x27;</span> : <span class=\"string\">&#x27;line&#x27;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 如果有 SQL，执行查询并构建图表（不采用打字机分段，只发送一次文本）</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (chartHint.<span class=\"property\">sql</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> rows = <span class=\"keyword\">await</span> <span class=\"title function_\">runQuery</span>(chartHint.<span class=\"property\">sql</span>) <span class=\"comment\">// 执行 SQL 查询</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Prompt2：基于原始问题 + SQL + 原始数据 生成完整 ECharts option JSON</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> prompt2 = <span class=\"string\">`你是一个 ECharts 可视化专家。\\n原始问题：<span class=\"subst\">$&#123;query&#125;</span>\\nSQL：<span class=\"subst\">$&#123;chartHint.sql&#125;</span>\\n原始数据(JSON 数组)：<span class=\"subst\">$&#123;<span class=\"built_in\">JSON</span>.stringify(rows)&#125;</span>\\n要求：返回一个合法的 ECharts option JSON 对象，仅输出 JSON，不要解释，不要代码块。`</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> optionText = <span class=\"keyword\">await</span> <span class=\"title function_\">withTimeout</span>(<span class=\"title function_\">callOllama</span>(prompt2), <span class=\"number\">30000</span>) || <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> optionFromLLM = <span class=\"title function_\">extractJsonOption</span>(optionText)</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">// 若 LLM 返回合法 JSON，但类型与用户意图不符，优先尊重用户意图</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (optionFromLLM) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">const</span> desired = <span class=\"title function_\">resolveDesiredChartType</span>(query, chartHint.<span class=\"property\">chartType</span>, chartTypeOverride)</span><br><span class=\"line\">          <span class=\"keyword\">let</span> finalOption = optionFromLLM</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (desired &amp;&amp; !<span class=\"title function_\">optionMatchesType</span>(optionFromLLM, desired)) &#123;</span><br><span class=\"line\">            finalOption = <span class=\"title function_\">buildOptionFromRows</span>(rows, query, desired, xKeyHint, yKeyHint)</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"title function_\">send</span>(&#123; <span class=\"attr\">type</span>: <span class=\"string\">&#x27;text&#x27;</span>, <span class=\"attr\">delta</span>: <span class=\"string\">`SQL 执行成功，共 <span class=\"subst\">$&#123;rows.length&#125;</span> 行。`</span> &#125;)</span><br><span class=\"line\">          <span class=\"title function_\">send</span>(&#123; <span class=\"attr\">type</span>: <span class=\"string\">&#x27;chart&#x27;</span>, <span class=\"attr\">sql</span>: chartHint.<span class=\"property\">sql</span>, <span class=\"attr\">option</span>: finalOption &#125;)</span><br><span class=\"line\">          <span class=\"title function_\">send</span>(&#123; <span class=\"attr\">type</span>: <span class=\"string\">&#x27;end&#x27;</span> &#125;)</span><br><span class=\"line\">          event.<span class=\"property\">node</span>.<span class=\"property\">res</span>.<span class=\"title function_\">end</span>()</span><br><span class=\"line\">          <span class=\"keyword\">return</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125; <span class=\"keyword\">catch</span> (err) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">console</span>.<span class=\"title function_\">error</span>(<span class=\"string\">&#x27;[DB] SQL 执行失败:&#x27;</span>, err)</span><br><span class=\"line\">        analysis += <span class=\"string\">&#x27;SQL 执行失败，已回退示例图表。&#x27;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125; .<span class=\"title function_\">catch</span>(<span class=\"params\">e</span>) &#123;</span><br><span class=\"line\">    analysis += <span class=\"string\">&#x27;（数据库或模型步骤出现问题，已使用内置方案。）&#x27;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 5. 发送结束信号 &amp; 结束响应</span></span><br><span class=\"line\">  <span class=\"title function_\">send</span>(&#123; <span class=\"attr\">type</span>: <span class=\"string\">&quot;end&quot;</span> &#125;); </span><br><span class=\"line\">  event.<span class=\"property\">node</span>.<span class=\"property\">res</span>.<span class=\"title function_\">end</span>();</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 执行 SQL 查询 </span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> pool 数据库连接池</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> sql SQL 查询语句</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@returns</span> 查询结果行数组</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"comment\">// runQuery 已在 ~/utils/db 封装复用</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 提取返回中的 SQL（纯文本或代码块）</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">extractSqlFromText</span>(<span class=\"params\"><span class=\"attr\">text</span>: <span class=\"built_in\">string</span></span>): <span class=\"built_in\">string</span> &#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 提取并解析 LLM 返回的 JSON（支持 ```json 代码块或纯文本 JSON）</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">extractJsonOption</span>(<span class=\"params\"><span class=\"attr\">text</span>: <span class=\"built_in\">string</span></span>): <span class=\"title class_\">Record</span>&lt;<span class=\"built_in\">string</span>, <span class=\"built_in\">any</span>&gt; | <span class=\"literal\">null</span> &#123;</span><br><span class=\"line\">...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Promise 超时封装：超过 ms 返回 null</span></span><br><span class=\"line\"><span class=\"comment\">// withTimeout 已在 ~/utils/ollama 中统一复用</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 简易打字机：按块发送文本增量</span></span><br><span class=\"line\"><span class=\"comment\">// typewriter 已在 ~/utils/ollama 中统一复用</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 解析用户意图/覆盖与 chartHint，给出期望的图表类型</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">resolveDesiredChartType</span>(<span class=\"params\"><span class=\"attr\">query</span>: <span class=\"built_in\">string</span>, <span class=\"attr\">chartHint</span>?: <span class=\"built_in\">string</span>, <span class=\"attr\">override</span>?: <span class=\"built_in\">string</span></span>): <span class=\"string\">&#x27;line&#x27;</span>|<span class=\"string\">&#x27;bar&#x27;</span>|<span class=\"string\">&#x27;pie&#x27;</span> | <span class=\"literal\">null</span> &#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 检查 option 中 series 的类型是否匹配期望</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">optionMatchesType</span>(<span class=\"params\"><span class=\"attr\">option</span>: <span class=\"built_in\">any</span>, <span class=\"attr\">desired</span>: <span class=\"string\">&#x27;line&#x27;</span>|<span class=\"string\">&#x27;bar&#x27;</span>|<span class=\"string\">&#x27;pie&#x27;</span></span>): <span class=\"built_in\">boolean</span> &#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 从查询结果行数组构建图表选项</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> rows 查询结果行数组</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> query 用户查询字符串</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> chartType 图表类型（可选）</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@returns</span> 图表选项对象</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">buildOptionFromRows</span>(<span class=\"params\"><span class=\"attr\">rows</span>: <span class=\"built_in\">any</span>[], <span class=\"attr\">query</span>: <span class=\"built_in\">string</span>, <span class=\"attr\">chartType</span>?: <span class=\"built_in\">string</span>, <span class=\"attr\">xKeyHint</span>?: <span class=\"built_in\">string</span>, <span class=\"attr\">yKeyHint</span>?: <span class=\"built_in\">string</span></span>): <span class=\"title class_\">Record</span>&lt;<span class=\"built_in\">string</span>, <span class=\"built_in\">any</span>&gt; &#123;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>前端关键代码：</p>\n  <figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"> </span></span><br><span class=\"line\"><span class=\"language-javascript\">  <span class=\"keyword\">const</span> <span class=\"title function_\">send</span> = <span class=\"keyword\">async</span> (<span class=\"params\"></span>) =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">const</span> <span class=\"attr\">userMsg</span>: <span class=\"title class_\">Message</span> = &#123; <span class=\"attr\">id</span>: <span class=\"title class_\">Date</span>.<span class=\"title function_\">now</span>(), <span class=\"attr\">role</span>: <span class=\"string\">&#x27;user&#x27;</span>, <span class=\"attr\">text</span>: input.<span class=\"property\">value</span> &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    messages.<span class=\"property\">value</span>.<span class=\"title function_\">push</span>(userMsg)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">const</span> res = <span class=\"keyword\">await</span> <span class=\"title function_\">fetch</span>(<span class=\"string\">&#x27;/api/generatev2&#x27;</span>, &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"attr\">method</span>: <span class=\"string\">&#x27;POST&#x27;</span>,</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"attr\">headers</span>: &#123; <span class=\"string\">&#x27;Content-Type&#x27;</span>: <span class=\"string\">&#x27;application/json&#x27;</span> &#125;,</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"attr\">body</span>: <span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(&#123; <span class=\"attr\">query</span>: input.<span class=\"property\">value</span> &#125;)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">if</span> (!res.<span class=\"property\">body</span>) <span class=\"keyword\">return</span> <span class=\"literal\">false</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">const</span> reader = res.<span class=\"property\">body</span>.<span class=\"title function_\">getReader</span>()</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">const</span> decoder = <span class=\"keyword\">new</span> <span class=\"title class_\">TextDecoder</span>(<span class=\"string\">&#x27;utf-8&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">let</span> buffer = <span class=\"string\">&#x27;&#x27;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"comment\">// 临时的 assistant 消息</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">const</span> assistantMsg = reactive&lt;<span class=\"title class_\">Message</span>&gt;(&#123; <span class=\"attr\">id</span>: <span class=\"title class_\">Date</span>.<span class=\"title function_\">now</span>() + <span class=\"number\">1</span>, <span class=\"attr\">role</span>: <span class=\"string\">&#x27;assistant&#x27;</span>, <span class=\"attr\">text</span>: <span class=\"string\">&#x27;&#x27;</span> &#125;)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    messages.<span class=\"property\">value</span>.<span class=\"title function_\">push</span>(assistantMsg)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">const</span> &#123; done, value &#125; = <span class=\"keyword\">await</span> reader.<span class=\"title function_\">read</span>() <span class=\"comment\">// 读取数据块</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">if</span> (done) <span class=\"keyword\">break</span> <span class=\"comment\">// 流结束</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">      buffer += decoder.<span class=\"title function_\">decode</span>(value, &#123; <span class=\"attr\">stream</span>: <span class=\"literal\">true</span> &#125;)</span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">const</span> chunks = buffer.<span class=\"title function_\">split</span>(<span class=\"string\">&quot;\\n\\n&quot;</span>) <span class=\"comment\">// 按 SSE 格式分割消息</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">      buffer = chunks.<span class=\"title function_\">pop</span>() || <span class=\"string\">&#x27;&#x27;</span> <span class=\"comment\">// 保留不完整的消息到下一次循环中</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">      <span class=\"keyword\">for</span> (<span class=\"keyword\">const</span> chunk <span class=\"keyword\">of</span> chunks) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"keyword\">if</span> (!chunk.<span class=\"title function_\">startsWith</span>(<span class=\"string\">&#x27;data: &#x27;</span>)) <span class=\"keyword\">continue</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"keyword\">const</span> payloadStr = chunk.<span class=\"title function_\">slice</span>(<span class=\"number\">5</span>).<span class=\"title function_\">trim</span>()</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"keyword\">if</span> (!payloadStr) <span class=\"keyword\">continue</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"keyword\">const</span> payload = <span class=\"title class_\">JSON</span>.<span class=\"title function_\">parse</span>(payloadStr) <span class=\"comment\">// 解析JSON</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"comment\">// 根据后端定义的 type 执行不同操作</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"keyword\">if</span> (payload.<span class=\"property\">type</span> === <span class=\"string\">&#x27;text&#x27;</span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">          assistantMsg.<span class=\"property\">text</span> = (assistantMsg.<span class=\"property\">text</span> || <span class=\"string\">&#x27;&#x27;</span>) + <span class=\"title class_\">String</span>(payload.<span class=\"property\">delta</span> || <span class=\"string\">&#x27;&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (payload.<span class=\"property\">type</span> === <span class=\"string\">&#x27;chart&#x27;</span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">          <span class=\"comment\">// 收到图表消息，创建一个新的 assistant 消息来展示图表</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">          assistantMsg.<span class=\"property\">sql</span> = payload.<span class=\"property\">sql</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">          assistantMsg.<span class=\"property\">option</span> = payload.<span class=\"property\">option</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">        &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">      &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">  &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>后续加上界面的基础搭建和逻辑处理，我们就能实现一个简易的 AI + BI 的自动化分析功能了。</p>\n","feature":true,"text":"近期跟后端同事配合开发了一个AI智能对话系统，对 AI、LLM 等知识产生了浓厚的兴趣，故构建了一个基于大语言模型（LLM）的智能数据可视化引擎。用户可以通过自...","permalink":"/post/AI-前端自动化分析引擎实践","photos":[],"count_time":{"symbolsCount":"19k","symbolsTime":"17 mins."},"categories":[{"name":"AI","slug":"AI","count":2,"path":"api/categories/AI.json"}],"tags":[{"name":"SSE","slug":"SSE","count":2,"path":"api/tags/SSE.json"},{"name":"Ollama","slug":"Ollama","count":1,"path":"api/tags/Ollama.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E4%B8%80%E3%80%81%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF\"><span class=\"toc-text\">一、实现思路</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E4%BA%8C%E3%80%81%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B\"><span class=\"toc-text\">二、技术选型</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E4%B8%89%E3%80%81%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA\"><span class=\"toc-text\">三、项目搭建</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E5%9B%9B%E3%80%81%E9%87%8D%E7%82%B9%E4%BB%A3%E7%A0%81%EF%BC%9ASSE-%E5%AE%9E%E7%8E%B0%E6%B5%81%E5%BC%8F%E5%93%8D%E5%BA%94\"><span class=\"toc-text\">四、重点代码：SSE 实现流式响应</span></a></li></ol>","author":{"name":"YaZhen","slug":"blog-author","avatar":"/images/avatar.png","link":"/","description":"喜欢深耕知识的技术人","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"html基础知识总结","uid":"277836383f16252be2c700b77d8d09a4","slug":"html-基础知识总结","date":"2025-08-08T08:26:21.000Z","updated":"2025-11-24T16:12:21.363Z","comments":true,"path":"api/articles/html-基础知识总结.json","keywords":"React、Vue、Uniapp、Nodejs、性能与优化","cover":"./../images/cover.png","text":"一、HTML文档声明 HTML（HyperText Markup Language，超文本标记语言）是一种用于创建网页的标准标记语言。1993年6月 HTML1...","permalink":"/post/html-基础知识总结","photos":[],"count_time":{"symbolsCount":"17k","symbolsTime":"15 mins."},"categories":[{"name":"html","slug":"html","count":2,"path":"api/categories/html.json"}],"tags":[{"name":"技术总结","slug":"技术总结","count":4,"path":"api/tags/技术总结.json"}],"author":{"name":"YaZhen","slug":"blog-author","avatar":"/images/avatar.png","link":"/","description":"喜欢深耕知识的技术人","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"日常开发记录（一）","uid":"ca1142333058a14bccbfa0cfa83717fc","slug":"Vue-日常记录1","date":"2025-08-25T09:37:53.000Z","updated":"2025-08-25T12:41:23.313Z","comments":true,"path":"api/articles/Vue-日常记录1.json","keywords":"React、Vue、Uniapp、Nodejs、性能与优化","cover":"./../images/cover.png","text":"一、NavMenu 生成菜单栏时路由地址错误 问题描述：使用 EllementUI 中的 NavMenu 生成菜单栏导航时，路由的 path 总是多一个（eg:...","permalink":"/post/Vue-日常记录1","photos":[],"count_time":{"symbolsCount":"2.2k","symbolsTime":"2 mins."},"categories":[{"name":"Vue","slug":"Vue","count":2,"path":"api/categories/Vue.json"}],"tags":[{"name":"技术总结","slug":"技术总结","count":4,"path":"api/tags/技术总结.json"},{"name":"日常问题","slug":"日常问题","count":1,"path":"api/tags/日常问题.json"}],"author":{"name":"YaZhen","slug":"blog-author","avatar":"/images/avatar.png","link":"/","description":"喜欢深耕知识的技术人","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}